{% extends "base.html" %}

{% block title %}Quiz Generator - Academic Apex Strategist{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-3">
            <i class="fas fa-question-circle text-primary"></i>
            Quiz Generator
        </h1>
        <p class="text-lg opacity-70">
            Create comprehensive diagnostic quizzes for any subject with AI-powered content generation
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Form -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">
                    <i class="fas fa-edit text-secondary"></i>
                    Quiz Parameters
                </h2>

                <form id="quiz-form" class="space-y-4">
                    <!-- Subject -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Subject/Topic *</span>
                        </label>
                        <input 
                            type="text" 
                            id="subject" 
                            name="subject"
                            placeholder="e.g., Python Programming Basics, World War II, Calculus"
                            class="input input-bordered w-full" 
                            required
                        >
                        <label class="label">
                            <span class="label-text-alt">Be specific for better results</span>
                        </label>
                    </div>

                    <!-- Difficulty Level -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Difficulty Level</span>
                        </label>
                        <select id="difficulty" name="difficulty" class="select select-bordered w-full">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>

                    <!-- Number of Questions -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Number of Questions</span>
                        </label>
                        <input 
                            type="range" 
                            id="num_questions" 
                            name="num_questions"
                            min="5" 
                            max="25" 
                            value="10" 
                            class="range range-primary"
                        >
                        <div class="w-full flex justify-between text-xs px-2">
                            <span>5</span>
                            <span>15</span>
                            <span>25</span>
                        </div>
                        <div class="text-center mt-2">
                            <span id="questions-display" class="badge badge-primary">10 Questions</span>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="checkbox" /> 
                        <div class="collapse-title text-lg font-medium">
                            <i class="fas fa-cog mr-2"></i>
                            Advanced Options
                        </div>
                        <div class="collapse-content space-y-3">
                            <!-- Prompt Curation -->
                            <div class="form-control">
                                <label class="cursor-pointer label">
                                    <span class="label-text">Use Prompt Curation</span>
                                    <input 
                                        type="checkbox" 
                                        id="use_curation" 
                                        name="use_curation"
                                        class="toggle toggle-primary" 
                                        checked 
                                    >
                                </label>
                                <label class="label">
                                    <span class="label-text-alt opacity-60">
                                        Improves prompt quality but requires curator service
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="form-control mt-6">
                        <button 
                            type="submit" 
                            id="generate-btn" 
                            class="btn btn-primary btn-lg"
                            data-original-text="Generate Quiz"
                        >
                            <i class="fas fa-magic mr-2"></i>
                            Generate Quiz
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">
                    <i class="fas fa-file-alt text-accent"></i>
                    Generated Quiz
                </h2>

                <!-- Initial State -->
                <div id="initial-state" class="text-center py-12 opacity-60">
                    <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                    <p class="text-lg mb-2">Ready to Generate</p>
                    <p class="text-sm">Fill out the form and click "Generate Quiz" to create your educational content.</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-lg mb-2">Generating Quiz...</p>
                    <p class="text-sm opacity-70">This may take 30-60 seconds depending on complexity</p>
                    <progress class="progress progress-primary w-full mt-4"></progress>
                </div>

                <!-- Results -->
                <div id="results-content" class="hidden space-y-4">
                    <!-- Stats -->
                    <div class="stats stats-vertical lg:stats-horizontal shadow w-full text-sm">
                        <div class="stat">
                            <div class="stat-title text-xs">Length</div>
                            <div class="stat-value text-lg" id="content-length">-</div>
                            <div class="stat-desc">characters</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title text-xs">Model</div>
                            <div class="stat-value text-base" id="model-used">-</div>
                            <div class="stat-desc" id="tokens-used">0 tokens</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title text-xs">Storage</div>
                            <div class="stat-value text-sm">
                                <i class="fas fa-check text-success" id="file-saved-icon"></i>
                                <i class="fas fa-times text-error hidden" id="file-error-icon"></i>
                            </div>
                            <div class="stat-desc">
                                <span id="obsidian-status">File saved</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content Preview -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Quiz Preview</span>
                            <div class="label-text-alt space-x-2">
                                <button onclick="copyToClipboard()" class="btn btn-ghost btn-xs">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button onclick="downloadQuiz()" class="btn btn-ghost btn-xs">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </label>
                        <textarea 
                            id="quiz-content" 
                            class="textarea textarea-bordered h-96 font-mono text-sm" 
                            readonly
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2 justify-center">
                        <button onclick="generateAnother()" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i>
                            Generate Another
                        </button>
                        <button onclick="viewInFiles()" class="btn btn-secondary btn-sm">
                            <i class="fas fa-folder"></i>
                            View in Files
                        </button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden">
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h3 class="font-bold">Generation Failed</h3>
                            <div id="error-message" class="text-sm mt-1">An error occurred during quiz generation.</div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="retryGeneration()" class="btn btn-primary btn-sm">
                            <i class="fas fa-redo"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tips Section -->
    <div class="card bg-gradient-to-r from-primary/10 to-secondary/10 shadow-lg">
        <div class="card-body">
            <h3 class="card-title text-lg">
                <i class="fas fa-lightbulb text-warning"></i>
                Tips for Better Quizzes
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="space-y-2">
                    <h4 class="font-semibold text-sm">📝 Subject Specificity</h4>
                    <ul class="text-sm space-y-1 opacity-80">
                        <li>• Use specific topics: "Python Functions" vs "Programming"</li>
                        <li>• Include context: "Beginner Web Development with HTML/CSS"</li>
                        <li>• Mention target audience when relevant</li>
                    </ul>
                </div>
                <div class="space-y-2">
                    <h4 class="font-semibold text-sm">🎯 Difficulty Guidelines</h4>
                    <ul class="text-sm space-y-1 opacity-80">
                        <li>• <strong>Beginner:</strong> Basic concepts, definitions, simple examples</li>
                        <li>• <strong>Intermediate:</strong> Application, analysis, connections</li>
                        <li>• <strong>Advanced:</strong> Synthesis, evaluation, complex scenarios</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lastGeneratedFilename = null;

// Update questions display
document.getElementById('num_questions').addEventListener('input', function() {
    const value = this.value;
    document.getElementById('questions-display').textContent = `${value} Questions`;
});

// Form submission
document.getElementById('quiz-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        subject: formData.get('subject'),
        difficulty: formData.get('difficulty'),
        num_questions: parseInt(formData.get('num_questions')),
        use_curation: formData.get('use_curation') === 'on'
    };
    
    // Show loading state
    showState('loading');
    showLoading('#generate-btn');
    
    try {
        const response = await fetch('/generate-quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
            lastGeneratedFilename = result.filename;
            showNotification('Quiz generated successfully!', 'success');
        } else {
            showError(result.error || 'Generation failed');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    } finally {
        showLoading('#generate-btn', false);
    }
});

function showState(state) {
    // Hide all states
    document.getElementById('initial-state').classList.add('hidden');
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('results-content').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    
    // Show selected state
    if (state === 'loading') {
        document.getElementById('loading-state').classList.remove('hidden');
    } else if (state === 'results') {
        document.getElementById('results-content').classList.remove('hidden');
    } else if (state === 'error') {
        document.getElementById('error-state').classList.remove('hidden');
    } else {
        document.getElementById('initial-state').classList.remove('hidden');
    }
}

function displayResults(result) {
    // Update stats
    document.getElementById('content-length').textContent = result.stats.length.toLocaleString();
    document.getElementById('model-used').textContent = result.stats.model || 'Unknown';
    document.getElementById('tokens-used').textContent = (result.stats.tokens || 0) + ' tokens';
    
    // Update storage status
    const obsidianStatus = document.getElementById('obsidian-status');
    const savedIcon = document.getElementById('file-saved-icon');
    const errorIcon = document.getElementById('file-error-icon');
    
    if (result.obsidian_saved) {
        obsidianStatus.textContent = 'Saved to Obsidian';
        savedIcon.classList.remove('hidden');
        errorIcon.classList.add('hidden');
    } else {
        obsidianStatus.textContent = 'File saved locally';
        savedIcon.classList.add('hidden');
        errorIcon.classList.remove('hidden');
    }
    
    // Display content
    document.getElementById('quiz-content').value = result.content;
    
    showState('results');
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    showState('error');
    showNotification('Quiz generation failed: ' + message, 'error');
}

function retryGeneration() {
    document.getElementById('quiz-form').dispatchEvent(new Event('submit'));
}

function generateAnother() {
    showState('initial');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function copyToClipboard() {
    const content = document.getElementById('quiz-content').value;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('Quiz copied to clipboard!', 'success');
    }).catch(() => {
        showNotification('Failed to copy to clipboard', 'error');
    });
}

function downloadQuiz() {
    const content = document.getElementById('quiz-content').value;
    const subject = document.getElementById('subject').value;
    const filename = `quiz_${subject.replace(/\s+/g, '_').toLowerCase()}.md`;
    
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Quiz downloaded!', 'success');
}

function viewInFiles() {
    if (lastGeneratedFilename) {
        window.open(`/view/${lastGeneratedFilename}`, '_blank');
    } else {
        window.location.href = '/files';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Focus on subject input
    document.getElementById('subject').focus();
    
    // Set up form validation
    const form = document.getElementById('quiz-form');
    const subjectInput = document.getElementById('subject');
    
    subjectInput.addEventListener('input', function() {
        const generateBtn = document.getElementById('generate-btn');
        if (this.value.trim()) {
            generateBtn.disabled = false;
            generateBtn.classList.remove('btn-disabled');
        } else {
            generateBtn.disabled = true;
            generateBtn.classList.add('btn-disabled');
        }
    });
});
</script>
{% endblock %}
