{% extends "base.html" %}

{% block title %}{{ filename }} - Academic Apex Strategist{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="breadcrumbs text-sm">
            <ul>
                <li><a href="{{ url_for('list_files') }}">My Files</a></li>
                <li>{{ filename }}</li>
            </ul>
        </div>
        
        <div class="flex gap-2">
            <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-primary btn-sm">
                <i class="fas fa-download mr-1"></i>
                Download
            </a>
            <button onclick="copyContent()" class="btn btn-secondary btn-sm">
                <i class="fas fa-copy mr-1"></i>
                Copy
            </button>
        </div>
    </div>

    <!-- File Info -->
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    {% if file_type == 'md' %}
                        <i class="fas fa-file-alt text-primary text-2xl"></i>
                    {% elif file_type == 'py' %}
                        <i class="fas fa-file-code text-accent text-2xl"></i>
                    {% else %}
                        <i class="fas fa-file text-neutral text-2xl"></i>
                    {% endif %}
                    
                    <div>
                        <h1 class="text-xl font-bold">{{ filename }}</h1>
                        <div class="flex items-center space-x-4 text-sm opacity-70 mt-1">
                            <span>Type: {{ file_type.upper() if file_type else 'FILE' }}</span>
                            <span>Size: {{ (content|length / 1024) | round(1) }} KB</span>
                            <span>Lines: {{ content.splitlines()|length }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="badge badge-outline">
                    {{ file_type|upper if file_type else 'TEXT' }}
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body p-0">
            <!-- Toolbar -->
            <div class="flex items-center justify-between p-4 border-b border-base-300">
                <h2 class="text-lg font-semibold">
                    <i class="fas fa-eye mr-2"></i>
                    Content
                </h2>
                
                <div class="flex items-center space-x-2">
                    <button onclick="toggleWrap()" class="btn btn-ghost btn-sm" title="Toggle word wrap">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button onclick="toggleLineNumbers()" class="btn btn-ghost btn-sm" title="Toggle line numbers">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    {% if file_type == 'md' %}
                    <button onclick="togglePreview()" class="btn btn-ghost btn-sm" title="Toggle markdown preview">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Content Display -->
            <div class="relative">
                <!-- Raw Content -->
                <div id="raw-content" class="block">
                    <pre id="content-pre" class="p-4 overflow-auto text-sm leading-relaxed max-h-96 bg-base-100"><code id="content-code" class="{% if file_type == 'py' %}language-python{% elif file_type == 'md' %}language-markdown{% endif %}">{{ content }}</code></pre>
                </div>
                
                <!-- Markdown Preview -->
                {% if file_type == 'md' %}
                <div id="preview-content" class="hidden p-4 prose prose-sm max-w-none">
                    <!-- Markdown preview will be rendered here -->
                </div>
                {% endif %}
                
                <!-- Line Numbers (optional) -->
                <div id="line-numbers" class="absolute left-0 top-0 hidden bg-base-300 text-xs text-gray-500 p-4 select-none">
                    {% for line_num in range(1, content.splitlines()|length + 1) %}
                    <div class="leading-relaxed">{{ line_num }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata -->
    {% if file_type == 'md' %}
    <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">
                <i class="fas fa-info-circle mr-2"></i>
                Document Statistics
            </h3>
            
            <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                <div class="stat">
                    <div class="stat-title">Words</div>
                    <div class="stat-value text-lg" id="word-count">{{ content.split()|length }}</div>
                    <div class="stat-desc">Total word count</div>
                </div>
                
                <div class="stat">
                    <div class="stat-title">Characters</div>
                    <div class="stat-value text-lg">{{ content|length }}</div>
                    <div class="stat-desc">Including spaces</div>
                </div>
                
                <div class="stat">
                    <div class="stat-title">Reading Time</div>
                    <div class="stat-value text-lg">{{ (content.split()|length / 200) | round(0, 'ceil') | int }}</div>
                    <div class="stat-desc">Minutes (200 WPM)</div>
                </div>
                
                <div class="stat">
                    <div class="stat-title">Headings</div>
                    <div class="stat-value text-lg">{{ content.count('# ') + content.count('## ') + content.count('### ') }}</div>
                    <div class="stat-desc">H1-H3 levels</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="text-center space-x-2">
        <a href="{{ url_for('list_files') }}" class="btn btn-ghost">
            <i class="fas fa-arrow-left mr-1"></i>
            Back to Files
        </a>
        <button onclick="printContent()" class="btn btn-ghost">
            <i class="fas fa-print mr-1"></i>
            Print
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">

<!-- Markdown parser for preview -->
{% if file_type == 'md' %}
<script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
{% endif %}

<script>
let lineNumbersVisible = false;
let wordWrapEnabled = true;
{% if file_type == 'md' %}
let previewMode = false;
{% endif %}

function copyContent() {
    const content = document.getElementById('content-code').textContent;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('Content copied to clipboard!', 'success');
    }).catch(() => {
        showNotification('Failed to copy content', 'error');
    });
}

function toggleWrap() {
    const pre = document.getElementById('content-pre');
    wordWrapEnabled = !wordWrapEnabled;
    
    if (wordWrapEnabled) {
        pre.style.whiteSpace = 'pre-wrap';
        pre.style.wordBreak = 'break-word';
    } else {
        pre.style.whiteSpace = 'pre';
        pre.style.wordBreak = 'normal';
    }
}

function toggleLineNumbers() {
    const lineNumbers = document.getElementById('line-numbers');
    const contentPre = document.getElementById('content-pre');
    
    lineNumbersVisible = !lineNumbersVisible;
    
    if (lineNumbersVisible) {
        lineNumbers.classList.remove('hidden');
        contentPre.style.paddingLeft = '4rem';
    } else {
        lineNumbers.classList.add('hidden');
        contentPre.style.paddingLeft = '1rem';
    }
}

{% if file_type == 'md' %}
function togglePreview() {
    const rawContent = document.getElementById('raw-content');
    const previewContent = document.getElementById('preview-content');
    
    previewMode = !previewMode;
    
    if (previewMode) {
        // Parse markdown and show preview
        const markdown = document.getElementById('content-code').textContent;
        const html = marked.parse(markdown);
        previewContent.innerHTML = html;
        
        rawContent.classList.add('hidden');
        previewContent.classList.remove('hidden');
    } else {
        rawContent.classList.remove('hidden');
        previewContent.classList.add('hidden');
    }
}
{% endif %}

function printContent() {
    const content = document.getElementById('content-code').textContent;
    const filename = '{{ filename }}';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>${filename}</title>
            <style>
                body { 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    line-height: 1.4;
                    margin: 20px;
                }
                .header {
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                pre {
                    white-space: pre-wrap;
                    word-break: break-word;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${filename}</h1>
                <p>Generated by Academic Apex Strategist • ${new Date().toLocaleString()}</p>
            </div>
            <pre>${content}</pre>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Initialize syntax highlighting
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'c':
                if (window.getSelection().toString() === '') {
                    e.preventDefault();
                    copyContent();
                }
                break;
            case 'p':
                e.preventDefault();
                printContent();
                break;
            {% if file_type == 'md' %}
            case 'm':
                e.preventDefault();
                togglePreview();
                break;
            {% endif %}
        }
    }
});
</script>
{% endblock %}
