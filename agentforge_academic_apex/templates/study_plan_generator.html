{% extends "base.html" %}

{% block title %}Study Plan Generator - Academic Apex Strategist{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-3">
            <i class="fas fa-calendar-alt text-secondary"></i>
            Study Plan Generator
        </h1>
        <p class="text-lg opacity-70">
            Create detailed, minute-by-minute study plans with active learning techniques and strategic breaks
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Form -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">
                    <i class="fas fa-edit text-secondary"></i>
                    Study Plan Parameters
                </h2>

                <form id="study-plan-form" class="space-y-4">
                    <!-- Subject -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Subject/Topic *</span>
                        </label>
                        <input 
                            type="text" 
                            id="subject" 
                            name="subject"
                            placeholder="e.g., Machine Learning Fundamentals, Organic Chemistry, Spanish Grammar"
                            class="input input-bordered w-full" 
                            required
                        >
                        <label class="label">
                            <span class="label-text-alt">What do you want to study?</span>
                        </label>
                    </div>

                    <!-- Duration -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Study Duration</span>
                        </label>
                        <select id="duration" name="duration" class="select select-bordered w-full">
                            <option value="30 minutes">30 minutes</option>
                            <option value="1 hour">1 hour</option>
                            <option value="90 minutes">90 minutes</option>
                            <option value="2 hours" selected>2 hours</option>
                            <option value="3 hours">3 hours</option>
                            <option value="4 hours">4 hours</option>
                        </select>
                    </div>

                    <!-- Difficulty Level -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Learning Level</span>
                        </label>
                        <div class="join w-full">
                            <input class="join-item btn btn-sm flex-1" type="radio" name="difficulty" value="beginner" aria-label="Beginner">
                            <input class="join-item btn btn-sm flex-1" type="radio" name="difficulty" value="intermediate" aria-label="Intermediate" checked>
                            <input class="join-item btn btn-sm flex-1" type="radio" name="difficulty" value="advanced" aria-label="Advanced">
                        </div>
                    </div>

                    <!-- Learning Objectives -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Learning Objectives</span>
                        </label>
                        <div id="objectives-container" class="space-y-2">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    class="input input-bordered input-sm flex-1" 
                                    placeholder="e.g., Understand core concepts and terminology"
                                >
                                <button type="button" onclick="removeObjective(this)" class="btn btn-ghost btn-sm">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    class="input input-bordered input-sm flex-1" 
                                    placeholder="e.g., Apply knowledge to practical problems"
                                >
                                <button type="button" onclick="removeObjective(this)" class="btn btn-ghost btn-sm">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" onclick="addObjective()" class="btn btn-ghost btn-sm mt-2">
                            <i class="fas fa-plus"></i>
                            Add Objective
                        </button>
                    </div>

                    <!-- Advanced Options -->
                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="checkbox" /> 
                        <div class="collapse-title text-lg font-medium">
                            <i class="fas fa-cog mr-2"></i>
                            Advanced Options
                        </div>
                        <div class="collapse-content space-y-3">
                            <!-- Prompt Curation -->
                            <div class="form-control">
                                <label class="cursor-pointer label">
                                    <span class="label-text">Use Prompt Curation</span>
                                    <input 
                                        type="checkbox" 
                                        id="use_curation" 
                                        name="use_curation"
                                        class="toggle toggle-secondary" 
                                        checked 
                                    >
                                </label>
                                <label class="label">
                                    <span class="label-text-alt opacity-60">
                                        Optimizes prompt for better study plan structure
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="form-control mt-6">
                        <button 
                            type="submit" 
                            id="generate-btn" 
                            class="btn btn-secondary btn-lg"
                            data-original-text="Generate Study Plan"
                        >
                            <i class="fas fa-calendar-plus mr-2"></i>
                            Generate Study Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">
                    <i class="fas fa-file-alt text-accent"></i>
                    Study Plan Timeline
                </h2>

                <!-- Initial State -->
                <div id="initial-state" class="text-center py-12 opacity-60">
                    <i class="fas fa-clock text-6xl mb-4"></i>
                    <p class="text-lg mb-2">Ready to Plan</p>
                    <p class="text-sm">Configure your study session and generate a personalized learning timeline.</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12 hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-lg mb-2">Creating Study Plan...</p>
                    <p class="text-sm opacity-70">Designing optimal learning sequence with breaks and checkpoints</p>
                    <progress class="progress progress-secondary w-full mt-4"></progress>
                </div>

                <!-- Results -->
                <div id="results-content" class="hidden space-y-4">
                    <!-- Stats -->
                    <div class="stats stats-vertical lg:stats-horizontal shadow w-full text-sm">
                        <div class="stat">
                            <div class="stat-title text-xs">Length</div>
                            <div class="stat-value text-lg" id="content-length">-</div>
                            <div class="stat-desc">characters</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title text-xs">Duration</div>
                            <div class="stat-value text-base" id="plan-duration">-</div>
                            <div class="stat-desc">study time</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title text-xs">Storage</div>
                            <div class="stat-value text-sm">
                                <i class="fas fa-check text-success" id="file-saved-icon"></i>
                                <i class="fas fa-times text-error hidden" id="file-error-icon"></i>
                            </div>
                            <div class="stat-desc">
                                <span id="obsidian-status">Plan saved</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content Preview -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Study Plan Preview</span>
                            <div class="label-text-alt space-x-2">
                                <button onclick="copyToClipboard()" class="btn btn-ghost btn-xs">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button onclick="downloadPlan()" class="btn btn-ghost btn-xs">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button onclick="startStudySession()" class="btn btn-ghost btn-xs">
                                    <i class="fas fa-play"></i> Start Session
                                </button>
                            </div>
                        </label>
                        <textarea 
                            id="plan-content" 
                            class="textarea textarea-bordered h-96 font-mono text-sm" 
                            readonly
                        ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2 justify-center">
                        <button onclick="generateAnother()" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i>
                            Generate Another
                        </button>
                        <button onclick="viewInFiles()" class="btn btn-primary btn-sm">
                            <i class="fas fa-folder"></i>
                            View in Files
                        </button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden">
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <h3 class="font-bold">Planning Failed</h3>
                            <div id="error-message" class="text-sm mt-1">An error occurred during study plan generation.</div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="retryGeneration()" class="btn btn-secondary btn-sm">
                            <i class="fas fa-redo"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tips Section -->
    <div class="card bg-gradient-to-r from-secondary/10 to-accent/10 shadow-lg">
        <div class="card-body">
            <h3 class="card-title text-lg">
                <i class="fas fa-lightbulb text-warning"></i>
                Study Plan Best Practices
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="space-y-2">
                    <h4 class="font-semibold text-sm">⏰ Time Management</h4>
                    <ul class="text-sm space-y-1 opacity-80">
                        <li>• Include regular 5-10 minute breaks</li>
                        <li>• Start with easier concepts</li>
                        <li>• Save complex topics for peak focus time</li>
                    </ul>
                </div>
                <div class="space-y-2">
                    <h4 class="font-semibold text-sm">🧠 Learning Techniques</h4>
                    <ul class="text-sm space-y-1 opacity-80">
                        <li>• Mix reading, practice, and review</li>
                        <li>• Use active recall and spaced repetition</li>
                        <li>• Include self-assessment checkpoints</li>
                    </ul>
                </div>
                <div class="space-y-2">
                    <h4 class="font-semibold text-sm">📝 Objective Setting</h4>
                    <ul class="text-sm space-y-1 opacity-80">
                        <li>• Be specific about what you want to learn</li>
                        <li>• Include practical application goals</li>
                        <li>• Set measurable outcomes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Study Session Timer Modal -->
<dialog id="study_timer_modal" class="modal">
    <div class="modal-box w-11/12 max-w-md">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        
        <h3 class="font-bold text-lg mb-4">
            <i class="fas fa-stopwatch text-secondary"></i>
            Study Session Timer
        </h3>
        
        <div class="text-center space-y-4">
            <div class="text-4xl font-mono" id="timer-display">00:00:00</div>
            <div id="current-activity" class="text-lg font-semibold">Ready to start</div>
            <div class="flex gap-2 justify-center">
                <button id="timer-start" onclick="startTimer()" class="btn btn-secondary btn-sm">
                    <i class="fas fa-play"></i>
                </button>
                <button id="timer-pause" onclick="pauseTimer()" class="btn btn-warning btn-sm hidden">
                    <i class="fas fa-pause"></i>
                </button>
                <button id="timer-stop" onclick="stopTimer()" class="btn btn-error btn-sm">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
<script>
let lastGeneratedFilename = null;
let studyTimer = null;
let timerStartTime = null;
let timerPaused = false;

// Add/remove objectives
function addObjective() {
    const container = document.getElementById('objectives-container');
    const div = document.createElement('div');
    div.className = 'input-group';
    div.innerHTML = `
        <input 
            type="text" 
            class="input input-bordered input-sm flex-1" 
            placeholder="Enter learning objective..."
        >
        <button type="button" onclick="removeObjective(this)" class="btn btn-ghost btn-sm">
            <i class="fas fa-minus"></i>
        </button>
    `;
    container.appendChild(div);
}

function removeObjective(button) {
    const container = document.getElementById('objectives-container');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

// Form submission
document.getElementById('study-plan-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Get objectives
    const objectiveInputs = document.querySelectorAll('#objectives-container input');
    const objectives = Array.from(objectiveInputs)
        .map(input => input.value.trim())
        .filter(obj => obj.length > 0);
    
    const data = {
        subject: formData.get('subject'),
        duration: formData.get('duration'),
        difficulty: formData.get('difficulty'),
        objectives: objectives,
        use_curation: formData.get('use_curation') === 'on'
    };
    
    // Show loading state
    showState('loading');
    showLoading('#generate-btn');
    
    try {
        const response = await fetch('/generate-study-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
            lastGeneratedFilename = result.filename;
            showNotification('Study plan generated successfully!', 'success');
        } else {
            showError(result.error || 'Generation failed');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    } finally {
        showLoading('#generate-btn', false);
    }
});

function showState(state) {
    // Hide all states
    document.getElementById('initial-state').classList.add('hidden');
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('results-content').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    
    // Show selected state
    if (state === 'loading') {
        document.getElementById('loading-state').classList.remove('hidden');
    } else if (state === 'results') {
        document.getElementById('results-content').classList.remove('hidden');
    } else if (state === 'error') {
        document.getElementById('error-state').classList.remove('hidden');
    } else {
        document.getElementById('initial-state').classList.remove('hidden');
    }
}

function displayResults(result) {
    // Update stats
    document.getElementById('content-length').textContent = result.stats.length.toLocaleString();
    document.getElementById('plan-duration').textContent = document.getElementById('duration').value;
    
    // Update storage status
    const obsidianStatus = document.getElementById('obsidian-status');
    const savedIcon = document.getElementById('file-saved-icon');
    const errorIcon = document.getElementById('file-error-icon');
    
    if (result.obsidian_saved) {
        obsidianStatus.textContent = 'Saved to Obsidian';
        savedIcon.classList.remove('hidden');
        errorIcon.classList.add('hidden');
    } else {
        obsidianStatus.textContent = 'File saved locally';
        savedIcon.classList.add('hidden');
        errorIcon.classList.remove('hidden');
    }
    
    // Display content
    document.getElementById('plan-content').value = result.content;
    
    showState('results');
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    showState('error');
    showNotification('Study plan generation failed: ' + message, 'error');
}

function retryGeneration() {
    document.getElementById('study-plan-form').dispatchEvent(new Event('submit'));
}

function generateAnother() {
    showState('initial');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function copyToClipboard() {
    const content = document.getElementById('plan-content').value;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('Study plan copied to clipboard!', 'success');
    }).catch(() => {
        showNotification('Failed to copy to clipboard', 'error');
    });
}

function downloadPlan() {
    const content = document.getElementById('plan-content').value;
    const subject = document.getElementById('subject').value;
    const filename = `study_plan_${subject.replace(/\s+/g, '_').toLowerCase()}.md`;
    
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Study plan downloaded!', 'success');
}

function startStudySession() {
    document.getElementById('study_timer_modal').showModal();
}

function viewInFiles() {
    if (lastGeneratedFilename) {
        window.open(`/view/${lastGeneratedFilename}`, '_blank');
    } else {
        window.location.href = '/files';
    }
}

// Timer functionality
function startTimer() {
    timerStartTime = Date.now();
    timerPaused = false;
    
    document.getElementById('timer-start').classList.add('hidden');
    document.getElementById('timer-pause').classList.remove('hidden');
    document.getElementById('current-activity').textContent = 'Study session in progress';
    
    studyTimer = setInterval(updateTimer, 1000);
}

function pauseTimer() {
    timerPaused = true;
    clearInterval(studyTimer);
    
    document.getElementById('timer-start').classList.remove('hidden');
    document.getElementById('timer-pause').classList.add('hidden');
    document.getElementById('current-activity').textContent = 'Paused';
}

function stopTimer() {
    clearInterval(studyTimer);
    timerStartTime = null;
    timerPaused = false;
    
    document.getElementById('timer-display').textContent = '00:00:00';
    document.getElementById('timer-start').classList.remove('hidden');
    document.getElementById('timer-pause').classList.add('hidden');
    document.getElementById('current-activity').textContent = 'Ready to start';
}

function updateTimer() {
    if (timerStartTime && !timerPaused) {
        const elapsed = Date.now() - timerStartTime;
        const seconds = Math.floor(elapsed / 1000) % 60;
        const minutes = Math.floor(elapsed / 60000) % 60;
        const hours = Math.floor(elapsed / 3600000);
        
        const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('timer-display').textContent = display;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Focus on subject input
    document.getElementById('subject').focus();
    
    // Set up form validation
    const subjectInput = document.getElementById('subject');
    
    subjectInput.addEventListener('input', function() {
        const generateBtn = document.getElementById('generate-btn');
        if (this.value.trim()) {
            generateBtn.disabled = false;
            generateBtn.classList.remove('btn-disabled');
        } else {
            generateBtn.disabled = true;
            generateBtn.classList.add('btn-disabled');
        }
    });
});
</script>
{% endblock %}
